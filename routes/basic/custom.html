<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>自定义关键字 | Ajv</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="/ajv-docs-zh-cn/images/favicon.ico">
    <meta name="description" content="Ajv: Another JSON Schema Validator。Node.js和浏览器中最快速的JSON Schema验证器。">
    <link rel="preload" href="/ajv-docs-zh-cn/assets/css/0.styles.5a0f9214.css" as="style"><link rel="preload" href="/ajv-docs-zh-cn/assets/js/app.4497bbb7.js" as="script"><link rel="preload" href="/ajv-docs-zh-cn/assets/js/2.c7b6054d.js" as="script"><link rel="preload" href="/ajv-docs-zh-cn/assets/js/12.48708fcb.js" as="script"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/10.822ac3de.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/11.d15e32b7.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/13.032c4277.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/14.f0d24676.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/15.85afffdf.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/16.6a9932e7.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/17.26a096c7.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/18.e983eb27.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/19.a0f056a6.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/20.cccf14fa.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/21.48f7a45d.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/22.6db27886.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/23.5236c848.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/24.710052ba.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/25.28704c02.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/3.cf33746e.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/4.7351e2e0.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/5.9dba54a7.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/6.3569bd4e.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/7.8aa9081b.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/8.d355c7d2.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/9.1857401b.js">
    <link rel="stylesheet" href="/ajv-docs-zh-cn/assets/css/0.styles.5a0f9214.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/ajv-docs-zh-cn/" class="home-link router-link-active"><img src="/ajv-docs-zh-cn/images/logo.png" alt="Ajv" class="logo"> <span class="site-name can-hide">Ajv</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="http://www.febeacon.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  大笑文档
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/ajv-docs-zh-cn/" class="nav-link">
  文档首页
</a></div><div class="nav-item"><a href="/ajv-docs-zh-cn/routes/api/api.html" class="nav-link">
  API和配置项
</a></div><div class="nav-item"><a href="/ajv-docs-zh-cn/routes/packages/" class="nav-link">
  相关扩展包
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="http://www.febeacon.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  大笑文档
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/ajv-docs-zh-cn/" class="nav-link">
  文档首页
</a></div><div class="nav-item"><a href="/ajv-docs-zh-cn/routes/api/api.html" class="nav-link">
  API和配置项
</a></div><div class="nav-item"><a href="/ajv-docs-zh-cn/routes/packages/" class="nav-link">
  相关扩展包
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/ajv-docs-zh-cn/routes/basic/" class="sidebar-link">Ajv</a></li><li><a href="/ajv-docs-zh-cn/routes/basic/validation.html" class="sidebar-link">验证</a></li><li><a href="/ajv-docs-zh-cn/routes/basic/custom.html" class="active sidebar-link">自定义关键字</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/custom.html#内容" class="sidebar-link">内容</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/custom.html#使用验证函数定义关键字" class="sidebar-link">使用验证函数定义关键字</a></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/custom.html#使用-编译-函数验证关键字" class="sidebar-link">使用&quot;编译&quot;函数验证关键字</a></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/custom.html#使用-宏-函数定义关键字" class="sidebar-link">使用“宏”函数定义关键字</a></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/custom.html#使用-内联-函数定义关键字" class="sidebar-link">使用“内联”函数定义关键字</a></li></ul></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/custom.html#schema-编译上下文" class="sidebar-link">Schema 编译上下文</a></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/custom.html#验证时变量" class="sidebar-link">验证时变量</a></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/custom.html#ajv-工具" class="sidebar-link">Ajv 工具</a></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/custom.html#报告自定义关键字中的错误" class="sidebar-link">报告自定义关键字中的错误</a></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/custom.html#短路验证" class="sidebar-link">短路验证</a></li></ul></li><li><a href="/ajv-docs-zh-cn/routes/basic/coercion.html" class="sidebar-link">强制类型转换</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="定义自定义关键字">定义自定义关键字</h1> <p><a href="https://github.com/ajv-validator/ajv/blob/master/CUSTOM.md" target="_blank" rel="noopener noreferrer">英文原地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="内容">内容</h2> <h3 id="使用验证函数定义关键字">使用验证函数定义关键字</h3> <p>验证函数会在数据验证时调用，并传入：</p> <ul><li>schema</li> <li>数据</li> <li>父级 schema</li> <li>当前数据路径</li> <li>父级数据对象</li> <li>父级数据对象中的属性名</li> <li>根数据</li></ul> <p>对父级数据对象和当前属性名称的访问允许创建修改验证数据的关键字(在本例中，<strong>必须</strong>在关键字定义中使用<code>modifying</code>配置项)。</p> <p>该函数返回的验证结果应该是布尔值。它可以通过自身的<code>.errors</code>属性返回一个验证错误信息数组(否则将使用标准错误)。</p> <p>这种定义关键字方法的作用是：</p> <ul><li>在将关键字转换为编译后的/内联的关键字之前，先使用关键字。</li> <li>定义不依赖与 schema 值的关键字(比方说，值总为<code>true</code>时)。在这种情况下，您可以在关键字中添加配置项<code>schema: false</code>，这样 schema 就不会传递给验证函数，它将只接收与编译后的验证函数相同的 4 个参数(参见下一节)。</li> <li>定义关键字，其中 schema 是某个表达式中的值。</li> <li>定义支持<a href="https://github.com/ajv-validator/ajv#data-reference" target="_blank" rel="noopener noreferrer">$data 引用<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的关键字 —— 在这种情况下，验证函数是必需的，要么作为唯一的选项，要么作为编译、宏或内联函数的附加配置项(见下文)。</li></ul> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>在验证流因为 schema 不同而不同且必须使用<code>if</code>的情况下，这种定义关键字的方法比根据 schema 返回不同验证函数的编译关键字的性能更差。</p></div> <p>示例。<code>constant</code>关键字(draft-06 <code>const</code>关键字的同义词，它相当于只有一个项的<code>enum</code>关键字)。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ajv<span class="token punctuation">.</span><span class="token function">addKeyword</span><span class="token punctuation">(</span><span class="token string">'constant'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">validate</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">schema<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">typeof</span> schema <span class="token operator">==</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> schema <span class="token operator">!==</span> <span class="token keyword">null</span>
            <span class="token operator">?</span> <span class="token function">deepEqual</span><span class="token punctuation">(</span>schema<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
            <span class="token punctuation">:</span> schema <span class="token operator">===</span> data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  errors<span class="token punctuation">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;constant&quot;</span><span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> validate <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>

<span class="token keyword">var</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;constant&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;foo&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;bar&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> validate <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>foo<span class="token punctuation">:</span> <span class="token string">'bar'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>foo<span class="token punctuation">:</span> <span class="token string">'baz'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>Ajv 中已经能够使用<code>const</code>关键字。</p> <div class="custom-block tip"><p class="custom-block-title">请注意</p> <p>如果关键字没有定义自定义错误(参见<a href="https://github.com/ajv-validator/ajv/blob/master/CUSTOM.md#reporting-errors-in-custom-keywords" target="_blank" rel="noopener noreferrer">自定义关键字中的错误报告<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)，则在其定义中传入<code>error: false</code>可以使生成的代码更有效。</p></div> <p>添加异步关键字可以在定义中传入<code>async: true</code>。</p> <h3 id="使用-编译-函数验证关键字">使用&quot;编译&quot;函数验证关键字</h3> <p>在 schema 编译期间调用编译函数。它将传入 schema、父级 schema 和<a href="https://github.com/ajv-validator/ajv/blob/master/CUSTOM.md#schema-compilation-context" target="_blank" rel="noopener noreferrer">schema 编译上下文<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，并且它应该返回一个验证函数。该验证函数将在验证期间传入：</p> <ul><li>数据</li> <li>当前数据路径</li> <li>父级数据对象</li> <li>父级数据对象的属性名</li> <li>根数据</li></ul> <p>对父级数据对象和当前属性名的访问允许创建修改验证数据的关键字(<strong>必须</strong>使用<code>modifying</code>配置项)。</p> <p>该函数返回的验证结果应该是布尔值。它可以通过自身的<code>.errors</code>属性返回一个验证错误信息数组(否则将使用标准错误)。</p> <p>在某些情况下，这是定义关键字的最佳方法，但是它会在产生额外的函数调用，损失一些性能。如果关键字逻辑可以通过其他一些 JSON schema 来表达，那么<code>macro</code>关键字定义就更有效了(见下文)。</p> <p>所有自定义关键字类型的定义中都有一个可选属性<code>metaSchema</code>，在 schema 编译期间，关键字的值将根据该 schema 进行验证。</p> <p>自定义关键字再起定义中还有一个可选属性<code>dependencies</code> —— 它是包含了(父级) schema 中必需的关键字列表。</p> <p>示例：使用编译 schema 的<code>range</code>和<code>exclusiveRange</code>关键字。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ajv<span class="token punctuation">.</span><span class="token function">addKeyword</span><span class="token punctuation">(</span><span class="token string">'range'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  type<span class="token punctuation">:</span> <span class="token string">'number'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">compile</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">sch<span class="token punctuation">,</span> parentSchema</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> min <span class="token operator">=</span> sch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> max <span class="token operator">=</span> sch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> parentSchema<span class="token punctuation">.</span>exclusiveRange <span class="token operator">===</span> <span class="token boolean">true</span>
            <span class="token operator">?</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> data <span class="token operator">&gt;</span> min <span class="token operator">&amp;&amp;</span> data <span class="token operator">&lt;</span> max<span class="token punctuation">;</span> <span class="token punctuation">}</span>
            <span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> data <span class="token operator">&gt;=</span> min <span class="token operator">&amp;&amp;</span> data <span class="token operator">&lt;=</span> max<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  errors<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  metaSchema<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'array'</span><span class="token punctuation">,</span>
    items<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'number'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'number'</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    additionalItems<span class="token punctuation">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;range&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">&quot;exclusiveRange&quot;</span><span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> validate <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">2.01</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">3.99</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>参见上一小节中的自定义错误和异步关键字。</p> <h3 id="使用-宏-函数定义关键字">使用“宏”函数定义关键字</h3> <p>&quot;宏&quot;函数会在 schema 编译期间调用。它将传入 schema、父级 schema 和<a href="https://github.com/ajv-validator/ajv/blob/master/CUSTOM.md#schema-compilation-context" target="_blank" rel="noopener noreferrer">schema 编译上下文<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，并且它应该返回另一个 schema，除了原始 schema 外，它还将应用于数据。</p> <p>(在关键字逻辑可以用另一个 JSON schema 表示的情况下)它是最有效的方法，因为它通常很容易实现，而且在验证期间没有调用额外的函数。</p> <p>除了来自扩展的 schema 的错误外，宏关键字还会在验证失败时添加它自己的错误。</p> <p>示例：使用宏来定义前面例子的<code>range</code>和<code>exclusiveRange</code>关键字。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ajv<span class="token punctuation">.</span><span class="token function">addKeyword</span><span class="token punctuation">(</span><span class="token string">'range'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  type<span class="token punctuation">:</span> <span class="token string">'number'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">macro</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">schema<span class="token punctuation">,</span> parentSchema</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      minimum<span class="token punctuation">:</span> schema<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      maximum<span class="token punctuation">:</span> schema<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      exclusiveMinimum<span class="token punctuation">:</span> <span class="token operator">!</span><span class="token operator">!</span>parentSchema<span class="token punctuation">.</span>exclusiveRange<span class="token punctuation">,</span>
      exclusiveMaximum<span class="token punctuation">:</span> <span class="token operator">!</span><span class="token operator">!</span>parentSchema<span class="token punctuation">.</span>exclusiveRange
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  metaSchema<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'array'</span><span class="token punctuation">,</span>
    items<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'number'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'number'</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    additionalItems<span class="token punctuation">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>示例：5+ 版本提议中的<code>contains</code>关键字要求数组至少有一个项能匹配 schema，参见<a href="https://github.com/json-schema/json-schema/wiki/contains-(v5-proposal)" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;contains&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;number&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;minimum&quot;</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token string">&quot;exclusiveMinimum&quot;</span><span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> validate <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">addKeyword</span><span class="token punctuation">(</span><span class="token string">'contains'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  type<span class="token punctuation">:</span> <span class="token string">'array'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">macro</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">schema</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;not&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;items&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;not&quot;</span><span class="token punctuation">:</span> schema
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true, 数字 5 匹配了 schema 内部的 &quot;contains&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>若 Ajv 设置了配置项<code>v5: true</code>，则<code>contains</code>关键字可以使用。</p> <p>参见<a href="https://github.com/ajv-validator/ajv/blob/master/spec/custom.spec.js#L151" target="_blank" rel="noopener noreferrer">测试<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中的递归宏关键字<code>deepProperties</code>。</p> <h3 id="使用-内联-函数定义关键字">使用“内联”函数定义关键字</h3> <p>在 schema 编译期间使用内联编译函数。它接收4个参数：<code>it</code>(当前 schema 编译上下文)、<code>keyword</code>(3.0 版本中添加，允许使用一个函数定义多个关键字)、<code>schema</code>和<code>parentSchema</code>，并且它应该返回将要内联到已编译 schema 代码中的代码(以字符串形式)。该代码可以是计算验证结果的表达式，也可以是将验证结果分配给变量的一组语句。</p> <p>虽然使用&quot;内联&quot;函数定义关键字更具挑战性，它也有许多优点：</p> <ul><li>性能最好</li> <li>精确控制验证过程</li> <li>访问父级数据和当前验证数据的路径</li> <li>通过<code>it.util</code>访问 Ajv 工具</li></ul> <p><code>even</code>关键字的示例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">&quot;even&quot;</span><span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> validate <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">addKeyword</span><span class="token punctuation">(</span><span class="token string">'even'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  type<span class="token punctuation">:</span> <span class="token string">'number'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">inline</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">it<span class="token punctuation">,</span> keyword<span class="token punctuation">,</span> schema</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> op <span class="token operator">=</span> schema <span class="token operator">?</span> <span class="token string">'==='</span> <span class="token punctuation">:</span> <span class="token string">'!=='</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">'data'</span> <span class="token operator">+</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span>dataLevel <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' % 2 '</span> <span class="token operator">+</span> op <span class="token operator">+</span> <span class="token string">' 0'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  metaSchema<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'boolean'</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>上面示例中的<code>'data' + (it.dataLevel || '')</code>是对当前验证数据的引用。还要注意<code>schema</code>关键字和<code>it.schema.event</code>是相同的。即便如此，schema 在这里也并非严格必需的 —— 传递它是为了方便。</p> <p>示例：使用<a href="https://github.com/olado/doT" target="_blank" rel="noopener noreferrer">doT Template<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>定义<code>range</code>关键字：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// {% raw %}</span>
<span class="token keyword">var</span> doT <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dot'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> inlineRangeTemplate <span class="token operator">=</span> doT<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">&quot;\
{{ \
  var $data = 'data' + (it.dataLevel || '') \
    , $min = it.schema.range[0] \
    , $max = it.schema.range[1] \
    , $gt = it.schema.exclusiveRange ? '&gt;' : '&gt;=' \
    , $lt = it.schema.exclusiveRange ? '&lt;' : '&lt;='; \
}} \
var valid{{=it.level}} = {{=$data}} {{=$gt}} {{=$min}} &amp;&amp; {{=$data}} {{=$lt}} {{=$max}}; \
&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ajv<span class="token punctuation">.</span><span class="token function">addKeyword</span><span class="token punctuation">(</span><span class="token string">'range'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  type<span class="token punctuation">:</span> <span class="token string">'number'</span><span class="token punctuation">,</span>
  inline<span class="token punctuation">:</span> inlineRangeTemplate<span class="token punctuation">,</span>
  statements<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  metaSchema<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> <span class="token string">'array'</span><span class="token punctuation">,</span>
    items<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'number'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> type<span class="token punctuation">:</span> <span class="token string">'number'</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    additionalItems<span class="token punctuation">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {% endraw %}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>上面示例中的<code>'valid' + it.level</code>应该讲验证结果设置为变量的预期名字。</p> <p>如果验证代码设置了变量而非对验证结果求值的话，关键字定义中的<code>statements</code>属性应该设置为<code>true</code>。</p> <p>定义内联关键字的主要挑战是：您必须编写在 schema 编译(编译时)和代码在数据验证过程(验证时 —— 这段代码可以使用字符串拼接或使用模板生成，见下面的示例)都执行的代码。</p> <p>Ajv 使用了<a href="https://github.com/olado/doT" target="_blank" rel="noopener noreferrer">doT Template<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>来生成验证函数的代码，由于模板和代码中使用的语法不同，验证函数的代码更容易分离编译时代码和验证时代码。Ajv 还为编译时和验证时变量了使用不同的变量名，以便更容易区分 —— 编译时变量名以<code>$</code>开头。</p> <p>此外还必须记住的是，编译时变量存在于为编译关键字而编写的函数的作用域内，因此它们是隔离的，但验证时变量与单个验证函数作用域内的所有变量共享作用域。因此，如果关键字存在子 schema，则必须在变量名中添加 schema 级别(<code>it.level</code>)。</p> <p>请参阅下面一小节来获取更多信息。</p> <h2 id="schema-编译上下文">Schema 编译上下文</h2> <p>传给<code>inline</code>关键字编译函数的第一个参数(传递给<code>compile</code>和<code>macro</code>关键字函数的第三个参数)是<code>it</code>，即 schema 编译上下文。这里的所有属性和函数在关键字可以放心使用，它们不会被重命名，也不会在没有主要版本变化的情况下改变其含义。</p> <p><code>it</code>对象具有以下属性：</p> <table><thead><tr><th style="text-align:center;"><code>it</code>的属性</th> <th>描述</th></tr></thead> <tbody><tr><td style="text-align:center;"><code>level</code></td> <td>当前 schema 的级别，顶层为<code>0</code>，子级 schema 为<code>1</code>(例如<code>property</code>中的 schema 或<code>anyOf</code>关键字中的 schema)。该属性的值应该附加到您在生成的代码中使用的验证时变量。</td></tr> <tr><td style="text-align:center;"><code>dataLevel</code></td> <td>当前已验证数据的级别。它可以用于从上到下访问所有级别上的属性名和数据。参见<a href="https://github.com/ajv-validator/ajv/blob/master/CUSTOM.md#validation-time-variables" target="_blank" rel="noopener noreferrer">验证时间变量<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</td></tr> <tr><td style="text-align:center;"><code>schema</code></td> <td>当前级别的 schema。您的关键字的值是<code>it.schema[keyword]</code>，该值会作为第三个参数传递给内联编译函数，而当前级别 schema 则会作为第四个参数。</td></tr> <tr><td style="text-align:center;"><code>schemaPath</code></td> <td>验证时间表达式，计算结果为当前 schema 的属性名。</td></tr> <tr><td style="text-align:center;"><code>baseId</code></td> <td>应该用作解析引用($ref)中 URI 基础的 base URI。</td></tr> <tr><td style="text-align:center;"><code>async</code></td> <td>如果当前 schema 是异步的则为真值。</td></tr> <tr><td style="text-align:center;"><code>opts</code></td> <td>Ajv 实例的配置项。您不应该更改它们。</td></tr> <tr><td style="text-align:center;"><code>formats</code></td> <td>Ajv 实例中所有可用的格式，包括自定义格式。</td></tr> <tr><td style="text-align:center;"><code>compositeRule</code></td> <td>布尔值，表示当前 schema 是否位于符合关键字内，其中的部分规则失败并不意味着验证失败(<code>switch</code>中的<code>anyOf</code>、<code>oneOf</code>、<code>not</code>和<code>if</code>)。该值可以用来确定如果<code>allErrors</code>配置项的值不是<code>true</code>的时候是否可以在出现错误后立即返回验证结果。只有在关键字中有许多步骤并且可能定义多个错误时才需要这样做。</td></tr> <tr><td style="text-align:center;"><code>validate</code></td> <td>用于编译关键字中的子级 schema 的函数(例如，请参阅<code>switch</code>关键字的<a href="https://github.com/ajv-validator/ajv-keywords/blob/master/keywords/dot/switch.jst" target="_blank" rel="noopener noreferrer">实现<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)。</td></tr> <tr><td style="text-align:center;"><code>util</code></td> <td>可以用在内联变异函数中的<a href="https://github.com/ajv-validator/ajv/blob/master/CUSTOM.md#ajv-utilities" target="_blank" rel="noopener noreferrer">Ajv 工具<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td></tr> <tr><td style="text-align:center;"><code>self</code></td> <td>Ajv 实例</td></tr></tbody></table> <h2 id="验证时变量">验证时变量</h2> <p>您可以在关键字生成的(验证时)代码中使用许多变量和表达式。</p> <ul><li><code>'data' + (it.dataLevel || '')</code>：当前级别数据的变量名。</li> <li><code>'data' + ((it.dataLevel-1)||'')</code>：<code>it.dataLevel &gt; 0</code>时的父级数据。</li> <li><code>'rootData'</code>：根数据。</li> <li><code>it.dataPathArr[it.dataLevel]</code>：<code>it.dataLevel &gt; 0</code>时父级对象中指向当前数据的属性名称。</li> <li><code>'validate.schema'</code> 验证时当前验证函数的顶级 schema。</li> <li><code>'validate.schema' + it.schemaPath</code>：验证时可用的当前级别 schema (编译时的相同 schema 是<code>it.schema</code>) 。</li> <li><code>'validate.schema' + it.schemaPath + '.' + keyword</code>：自定义关键字在验证时的值。关键字是传给内联编译函数的第二个参数，从而允许使用同一个函数编译多个关键字。</li> <li><code>'valid' + it.level</code>：如果关键字返回语句而非表达式，则必须声明该变量并将验证结果分配给该变量（<code>statements: true</code>）。</li> <li><code>'errors'</code>：错误的数量。参见<a href="https://github.com/ajv-validator/ajv/blob/master/CUSTOM.md#reporting-errors-in-custom-keywords" target="_blank" rel="noopener noreferrer">自定义关键字中的错误报告<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li><code>vErrors</code>：到目前为止收集到的错误数组。。参见<a href="https://github.com/ajv-validator/ajv/blob/master/CUSTOM.md#reporting-errors-in-custom-keywords" target="_blank" rel="noopener noreferrer">自定义关键字中的错误报告<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li></ul> <h2 id="ajv-工具">Ajv 工具</h2> <p>您可以在你的内联关键字中使用一些有用的函数。这些函数可以作为<code>it.util</code>对象的属性。</p> <h4 id="copy-object-obj-object-target-object"><code>.copy(Object obj[, Object target]) -&gt; Object</code></h4> <p>克隆或扩展对象。如果传入一个对象，则克隆。如果传入两个对象，则使用第一个对象的属性扩展第二个。</p> <h4 id="tohash-array-arr-object"><code>.toHash(Array arr) -&gt; Object</code></h4> <p>将字符串数组转换为对象，其中每个字符串都成为值为<code>true</code>的键。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>it<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">toHash</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// { a: true, b: true, c: true }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="equal-value1-value2-boolean"><code>.equal(value1, value2) -&gt; Boolean</code></h4> <p>执行深度相等比较。该函数用于关键字<code>enum</code>、<code>constant</code>、<code>uniqueItems</code>中，并可用于自定义关键字。</p> <h4 id="getproperty-string-key-string"><code>.getProperty(String key) -&gt; String</code></h4> <p>将访问属性/项的键/索引字符串转换为 JavaScript 语法可以访问的样式(<code>.</code>语法或<code>[…]</code>语法)。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>it<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>   <span class="token comment">// &quot;.a&quot;</span>
it<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>   <span class="token comment">// &quot;['1']&quot;</span>
it<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;a'b&quot;</span><span class="token punctuation">)</span> <span class="token comment">// &quot;['a\\'b']&quot;</span>
it<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>     <span class="token comment">// &quot;[1]&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="schemahasrules-object-schema-object-rules-string"><code>.schemaHasRules(Object schema, Object rules) -&gt; String</code></h4> <p>确定传递的 schema 是否有需要验证的规则。这个函数应该在调用<code>it.validate</code>编译子集 schema 之前使用。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>it<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">schemaHasRules</span><span class="token punctuation">(</span>schema<span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token constant">RULES</span><span class="token punctuation">.</span>all<span class="token punctuation">)</span> <span class="token comment">// true or false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="escapequotes-string-str-string"><code>.escapeQuotes(String str) -&gt; String</code></h4> <p>对字符串中的单引号进行转义，这样就可以使用单引号将其插入到生成的代码的字符串常量中。</p> <h4 id="toquotedstring-string-str-string"><code>.toQuotedString(String str) -&gt; String</code></h4> <p>将字符串转换为单引号中的 JavaScript 字符串常量(使用转义字符串)。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>it<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">toQuotedString</span><span class="token punctuation">(</span><span class="token string">&quot;a'b&quot;</span><span class="token punctuation">)</span> <span class="token comment">// &quot;'a\\'b'&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="getdata-string-jsonpointer-number-datalevel-array-paths-string"><code>.getData(String jsonPointer, Number dataLevel, Array paths) -&gt; String</code></h4> <p>返回验证时间表达式，以基于传递的 json 指针安全地访问数据(参见示例)。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>it<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">'2/test/1'</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span>dataLevel<span class="token punctuation">,</span> it<span class="token punctuation">.</span>dataPathArr<span class="token punctuation">)</span>
<span class="token comment">// 结果依赖于当前 level</span>
<span class="token comment">// 如果 it.dataLevel 为 3，则结果为 &quot;data1 &amp;&amp; data1.test &amp;&amp; data1.test[1]&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="escapejsonpointer-string-str-string"><code>.escapeJsonPointer(String str) -&gt; String</code></h4> <p>将属性名称转换为 JSON 指针片段。</p> <h4 id="unescapejsonpointer-string-str-string"><code>.unescapeJsonPointer (String str) -&gt; String</code></h4> <p>将 JSON 指针片段转换为属性名。</p> <h4 id="unescapefragment-string-str-string"><code>.unescapeFragment(String str) -&gt; String</code></h4> <p>将属性名称转换为可在 URI 中使用的 JSON 指针片段。</p> <h4 id="escapefragment-string-str-string"><code>.escapeFragment(String str) -&gt; String</code></h4> <p>将 JSON 指针片段从 URI 转换为属性名。</p> <h2 id="报告自定义关键字中的错误">报告自定义关键字中的错误</h2> <p>除宏(macro)关键字外的所有自定义关键字可以选择创建自定义错误消息。</p> <p>同步验证和编译关键字应该通过将它们分配给验证函数的<code>.errors</code>属性来定义错误。异步关键字可以通过<code>new Ajv.ValidationError(erros)</code>返回 reject 的 promise，其中<code>errors</code>是自定义验证错误的数组(如果不想在异步关键字中定义自定义错误，则其验证函数可以返回值为<code>false</code>的 promise)。</p> <p>内联自定义关键字应该增加错误计数器<code>errors</code>，并将粗偶添加到<code>vErrors</code>数组(其值可以为 null)。对于异步和同步关键字这么做都是可以的。参见<a href="https://github.com/ajv-validator/ajv/blob/master/spec/custom_rules/range_with_errors.jst" target="_blank" rel="noopener noreferrer">example range keyword<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>当内联关键字执行验证验证时，Ajv 通过比较验证前后的错误计数来监查其是否创建了错误。要跳过这个检查，可以向关键字定义中添加<code>errors</code>配置项(它的值可以是<code>&quot;full&quot;</code>、<code>true</code>、<code>false</code>)：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ajv<span class="token punctuation">.</span><span class="token function">addKeyword</span><span class="token punctuation">(</span><span class="token string">'range'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  type<span class="token punctuation">:</span> <span class="token string">'number'</span><span class="token punctuation">,</span>
  inline<span class="token punctuation">:</span> inlineRangeTemplate<span class="token punctuation">,</span>
  statements<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  errors<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token comment">// 在验证失败时，关键字应当创建自定义错误</span>
  <span class="token comment">// errors: 'full' // 创建的错误应该设置了 dataPath</span>
  <span class="token comment">// errors: false // 关键字不会产生错误，Ajv 将添加一个默认错误</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>每个错误对象至少应该有<code>keyword</code>、<code>message</code>和<code>params</code>属性，其他属性随后添加。内联关键字可以在错误对象中定义<code>dataPath</code>和<code>schemaPath</code>属性，它们将由 Ajv 分配，除非关键字的<code>errors</code>配置项是<code>&quot;full&quot;</code>。</p> <p>如果自定义关键字不创建错误，则在关键字验证失败时将创建默认错误(参见<a href="https://github.com/ajv-validator/ajv#validation-errors" target="_blank" rel="noopener noreferrer">Ajv 的验证错误<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)。</p> <h2 id="短路验证">短路验证</h2> <p>在某些情况下，内联关键字可以在遇到错误时立即终止验证并返回结果。只有当您定义的关键字有许多标准需要验证，并且您希望它能够快速失败时才会这样。只有在关键字本身定义了错误时才需要这样做，否则 Ajv 将在创建默认错误时返回(如果满足以下条件)。</p> <p>在关键字返回结果之前，会检查两个条件：</p> <ul><li>不应使用<code>allErrors</code>配置项(<code>!it.opts.allErrors</code>应该为 true)。</li> <li>当某些关键字失败并不意味着验证失败(<code>!it.compositeRule</code>应该为 true)，当前 schema 不应该在复合规则中(例如<code>no</code>或<code>anyOf</code>)。</li></ul> <p>如果满足这些条件，您的关键字可以立即返回结果。如果当前 schema 是异步的(<code>it.async</code>的值不是<code>true</code>)，当其遇到错误<code>err</code>时，您可以将其添加到关键字的生成代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>vErrors <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> vErrors <span class="token operator">=</span> <span class="token punctuation">[</span>err<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">else</span> vErrors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
validate<span class="token punctuation">.</span>errors <span class="token operator">=</span> vErrors<span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>如果当前 schema 是异步返回结果的(<code>it.async</code>的值为<code>true</code>)，您需要：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>vErrors <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> vErrors <span class="token operator">=</span> <span class="token punctuation">[</span>err<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">else</span> vErrors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ValidationError</span><span class="token punctuation">(</span>vErrors<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ValidationError 在作用域内</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果使用了<code>allErrors</code>配置项，关键字应该在遇到错误后继续验证，从而找到尽可能多的错误。</p> <p>如果不使用<code>allErrors</code>配置项，但<code>it.compositeRule</code>为真值(truthy)，关键字可能会短路验证，但不应该返回最终的验证结果。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/ajv-docs-zh-cn/routes/basic/validation.html" class="prev">
        验证
      </a></span> <span class="next"><a href="/ajv-docs-zh-cn/routes/basic/coercion.html">
        强制类型转换
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/ajv-docs-zh-cn/assets/js/app.4497bbb7.js" defer></script><script src="/ajv-docs-zh-cn/assets/js/2.c7b6054d.js" defer></script><script src="/ajv-docs-zh-cn/assets/js/12.48708fcb.js" defer></script>
  </body>
</html>
