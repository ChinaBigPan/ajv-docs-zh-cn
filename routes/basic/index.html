<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ajv | Ajv</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="/ajv-docs-zh-cn/images/favicon.ico">
    <meta name="description" content="Ajv: Another JSON Schema Validator。Node.js和浏览器中最快速的JSON Schema验证器。">
    <link rel="preload" href="/ajv-docs-zh-cn/assets/css/0.styles.5a0f9214.css" as="style"><link rel="preload" href="/ajv-docs-zh-cn/assets/js/app.4497bbb7.js" as="script"><link rel="preload" href="/ajv-docs-zh-cn/assets/js/2.c7b6054d.js" as="script"><link rel="preload" href="/ajv-docs-zh-cn/assets/js/13.032c4277.js" as="script"><link rel="preload" href="/ajv-docs-zh-cn/assets/js/5.9dba54a7.js" as="script"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/10.822ac3de.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/11.d15e32b7.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/12.48708fcb.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/14.f0d24676.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/15.85afffdf.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/16.6a9932e7.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/17.26a096c7.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/18.e983eb27.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/19.a0f056a6.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/20.cccf14fa.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/21.48f7a45d.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/22.6db27886.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/23.5236c848.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/24.710052ba.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/25.28704c02.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/3.cf33746e.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/4.7351e2e0.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/6.3569bd4e.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/7.8aa9081b.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/8.d355c7d2.js"><link rel="prefetch" href="/ajv-docs-zh-cn/assets/js/9.1857401b.js">
    <link rel="stylesheet" href="/ajv-docs-zh-cn/assets/css/0.styles.5a0f9214.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/ajv-docs-zh-cn/" class="home-link router-link-active"><img src="/ajv-docs-zh-cn/images/logo.png" alt="Ajv" class="logo"> <span class="site-name can-hide">Ajv</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="http://www.febeacon.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  大笑文档
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/ajv-docs-zh-cn/" class="nav-link">
  文档首页
</a></div><div class="nav-item"><a href="/ajv-docs-zh-cn/routes/api/api.html" class="nav-link">
  API和配置项
</a></div><div class="nav-item"><a href="/ajv-docs-zh-cn/routes/packages/" class="nav-link">
  相关扩展包
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="http://www.febeacon.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  大笑文档
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/ajv-docs-zh-cn/" class="nav-link">
  文档首页
</a></div><div class="nav-item"><a href="/ajv-docs-zh-cn/routes/api/api.html" class="nav-link">
  API和配置项
</a></div><div class="nav-item"><a href="/ajv-docs-zh-cn/routes/packages/" class="nav-link">
  相关扩展包
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/ajv-docs-zh-cn/routes/basic/" class="active sidebar-link">Ajv</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/#开始" class="sidebar-link">开始</a></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/#在浏览器中使用" class="sidebar-link">在浏览器中使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/#ajv-和-内容安全策略-csp" class="sidebar-link">Ajv 和 内容安全策略(CSP)</a></li></ul></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/#命令行接口" class="sidebar-link">命令行接口</a></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/#验证关键字-看左边目录的验证那里" class="sidebar-link">验证关键字 (看左边目录的验证那里)</a></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/#注释关键字" class="sidebar-link">注释关键字</a></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/#格式" class="sidebar-link">格式</a></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/#使用-ref-组合-schema" class="sidebar-link">使用 $ref 组合 schema</a></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/#data-引用" class="sidebar-link">$data 引用</a></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/#merge-和-patch-关键字" class="sidebar-link">$merge 和 $patch 关键字</a></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/#自定义关键字" class="sidebar-link">自定义关键字</a></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/#异步-schema-编译" class="sidebar-link">异步 schema 编译</a></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/#异步验证" class="sidebar-link">异步验证</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/#使用带有异步验证函数的转换器" class="sidebar-link">使用带有异步验证函数的转换器</a></li></ul></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/#安全注意事项" class="sidebar-link">安全注意事项</a></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/#正则dos攻击-redos-attack" class="sidebar-link">正则Dos攻击(ReDos Attack)</a></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/#过滤数据" class="sidebar-link">过滤数据</a></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/#配置默认值" class="sidebar-link">配置默认值</a></li><li class="sidebar-sub-header"><a href="/ajv-docs-zh-cn/routes/basic/#强制数据类型转换" class="sidebar-link">强制数据类型转换</a></li></ul></li><li><a href="/ajv-docs-zh-cn/routes/basic/validation.html" class="sidebar-link">验证</a></li><li><a href="/ajv-docs-zh-cn/routes/basic/custom.html" class="sidebar-link">自定义关键字</a></li><li><a href="/ajv-docs-zh-cn/routes/basic/coercion.html" class="sidebar-link">强制类型转换</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><a href="http://www.febeacon.com" target="_blank" rel="noopener noreferrer"><img width="200" src="http://www.febeacon.com/images/febeacon_logo_2.png" style="display: block; margin: 50px auto 0;"></a> <h1 id="ajv">Ajv</h1> <p><a href="https://github.com/ajv-validator/ajv" target="_blank" rel="noopener noreferrer">英文原地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="安装">安装</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> ajv
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="开始">开始</h2> <p>您可以在<a href="https://tonicdev.com/npm/ajv" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>调试看看。</p> <p>做最快速的验证：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// Node.js require:</span>
<span class="token keyword">var</span> Ajv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ajv'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 或是 ESM/TypeScript import</span>
<span class="token keyword">import</span> Ajv <span class="token keyword">from</span> <span class="token string">'ajv'</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> ajv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ajv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可以传入配置项, 例如： {allErrors: true}</span>
<span class="token keyword">var</span> validate <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> valid <span class="token operator">=</span> <span class="token function">validate</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>valid<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>validate<span class="token punctuation">.</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>用最少的代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// ...</span>
<span class="token keyword">var</span> valid <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>schema<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>valid<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ajv<span class="token punctuation">.</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>或者</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// ...</span>
<span class="token keyword">var</span> valid <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">addSchema</span><span class="token punctuation">(</span>schema<span class="token punctuation">,</span> <span class="token string">'mySchema'</span><span class="token punctuation">)</span>
               <span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token string">'mySchema'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>valid<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ajv<span class="token punctuation">.</span><span class="token function">errorsText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>Ajv 将 schema 编译为函数并在所有情况下对其进行缓存(使用<a href="https://github.com/epoberezkin/fast-json-stable-stringify" target="_blank" rel="noopener noreferrer">fast-json-stable-stringify<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>对 schema 进行序列化，或是自定义函数为键)，这样下次使用相同的 schema 时(不一定是相同的对象实例)时，就不会再次编译。</p> <p>使用<code>compile</code>或<code>getSchema</code>方法(不需要额外调用其他函数)返回的已编译函数可以获得最佳性能。</p> <div class="custom-block warning"><p class="custom-block-title">请注意</p> <p>每次调用验证函数或<code>ajv.validate</code>时都会覆盖<code>errors</code>属性。如果你想之后再使用它(比如说在回调函数中)，您需要将<code>errors</code>数组赋值给另一个变量。</p></div> <div class="custom-block tip"><p class="custom-block-title">TypeScript</p> <p><code>ajv</code>提供了开箱即用的 TypeScript 声明。因此您无需安装已经弃用的<code>@types/ajv</code>模块。</p></div> <h2 id="在浏览器中使用">在浏览器中使用</h2> <p>如果需要在几个包中使用 Ajv，可以使用<code>npm run bundle</code>创建一个单独的UMD包。</p> <p>您可以直接在浏览器中加载 Ajv.</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ajv.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这个包可以用于不同的模块系统，如果没有找到则会创建全局变量<code>Ajv</code>。</p> <p>浏览器包可以在<a href="https://cdnjs.com/libraries/ajv" target="_blank" rel="noopener noreferrer">CDN<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>找到</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>一些框架，例如Dojo，可能会重新定义全局引入，这种方式与 CommonJS 模块格式是不兼容的。在这种情况下，必须先加载 Ajv 包，然后才能使用全局 Ajv。</p></div> <h3 id="ajv-和-内容安全策略-csp">Ajv 和 内容安全策略(CSP)</h3> <p>如果您正在使用 Ajv 在浏览器文档中编译一个 schema (这是典型用法)，但是它配置了内容安全策略(CSP, Content Security Policy)，该策略需要<code>script-src</code>指令且包含了<code>unsafe-eval</code>值。**注意：**⚠️，<code>unsafe-eval</code>值并不是一个安全的策略。因为它有可能打开文档的跨站脚本攻击。</p> <p>为了在不影响 CSP 的情况下使用 Ajv，您可以<a href="/ajv-docs-zh-cn/routes/cli">使用 CLI 对 schema 进行预编译</a>。这将把 schema JSON 转换为 JavaScript 文件，该文件会导出一个<code>validate</code>函数到运行时编译的模式中。</p> <p>需要注意的是预编译使用的是<a href="/ajv-docs-zh-cn/routes/pack">ajv-pack</a>进行的，它可以编译的模式特性有一些限制。成功的预编译应该和运行时编译的 schema 是相同的。</p> <h2 id="命令行接口">命令行接口</h2> <p><a href="/ajv-docs-zh-cn/routes/cli">ajv-cli</a>可以作为单独的 npm 包。它支持如下功能：</p> <ul><li>编译 JSON Schema 以测试其有效性。</li> <li>BETA：生成独立模块，导出不需要 Ajv 使用的验证函数(使用<a href="/ajv-docs-zh-cn/routes/pack">ajv-pack</a>)。</li> <li>将 schema 迁移到 draft-07 (采用<a href="https://github.com/epoberezkin/json-schema-migrate" target="_blank" rel="noopener noreferrer">json-schema-migrate<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)</li> <li>根据 JSON Schema 验证文件。</li> <li>根据 JSON Schema 测试数据的期望有效性。</li> <li>引用的 schema。</li> <li>自定义 meta-schema。</li> <li>JSON、JSON5、YAML和JavaScript格式的文件。</li> <li>所有的 Ajv 配置项。</li> <li>报告<a href="https://tools.ietf.org/html/rfc6902" target="_blank" rel="noopener noreferrer">JSON-patch<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>格式验证后的数据更改。</li></ul> <h2 id="验证关键字-看左边目录的验证那里">验证关键字 (看左边目录的验证那里)</h2> <h2 id="注释关键字">注释关键字</h2> <p>JSON Schema 规范定义了几个描述 schema 本身但不会触发验证的注释关键字。</p> <ul><li><code>title</code>和<code>description</code>：表示该 schema 数据代表的信息。</li> <li><code>$comment</code>：（draft-07 新增）。给开发人员的信息。通过设置<code>$comment</code>项，Ajv 可以记录或将注释字符串传递给用户提供的函数。</li> <li><code>default</code>：数据实例的默认值。</li> <li><code>examples</code>：（draft-06 新增）数据实例的数组。 Ajv 不会根据 schema 检查这些实例的有效性。</li> <li><code>readOnly</code>和<code>writeOnly</code>：(draft-07 新增) 根据数据源(数据库、api等)将数据实例标记为只读或只写。</li> <li><code>contentEncoding</code>：<a href="https://tools.ietf.org/html/rfc2045#section-6.1" target="_blank" rel="noopener noreferrer">RFC 2045<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。如：&quot;base64&quot;。</li> <li><code>contentMediaType</code>：<a href="https://tools.ietf.org/html/rfc2046" target="_blank" rel="noopener noreferrer">RFC 2046<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。如：&quot;image/png&quot;。</li></ul> <div class="custom-block tip"><p class="custom-block-title">请注意</p> <p>Ajv 没有实现关键字<code>example</code>、<code>contentEncoding</code>和<code>contentMediaType</code>的验证，但保留了它们。如果您想创建一个插件来实现其中的一些关键字，应该从实例中删除这些它们。</p></div> <h2 id="格式">格式</h2> <p>Ajv 实现了由 JSON schema 规范定义的格式和一些其他格式。建议<strong>不要</strong>对不受信任的数据使用<code>format</code>关键字实现，因为它们使用了潜在的不安全的正则表达式。</p> <div class="custom-block tip"><p class="custom-block-title">请注意</p> <p>如果您需要使用<code>format</code>关键字来验证不受信任的数据，那么您必须评估它们对于您的验证场景的适用性和安全性。</p></div> <p>使用“format”关键字进行字符串验证，实现了下面这些格式：</p> <ul><li>date: 根据<a href="http://tools.ietf.org/html/rfc3339#section-5.6" target="_blank" rel="noopener noreferrer">RFC3339<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>实现的日期。</li> <li>time: 带时区的时间。</li> <li>data-time: 同来源的日期时间(时区是强制性的)。<code>date</code>、<code>time</code>和<code>date-time</code>在<code>full</code>模式下验证区间而在<code>fast</code>模式下仅用正则验证。</li> <li>uri: full URI。</li> <li>uri-reference: URI引用，包括完整的和相对的URI。</li> <li>uri-template: 根据<a href="https://tools.ietf.org/html/rfc6570" target="_blank" rel="noopener noreferrer">RFC6570<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的 URI 模板。</li> <li>email: 邮箱地址。</li> <li>hostname: 根据<a href="http://tools.ietf.org/html/rfc1034#section-3.5" target="_blank" rel="noopener noreferrer">RFC1034<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的 host 名。</li> <li>ipv4: IP 地址 v4。</li> <li>ipv6: IP 地址 v6。</li> <li>regex: 通过传入正则表达式构造器来验证字符串是否是一个可用的正则表达式。</li> <li>uuid: 全局惟一标识符。根据<a href="http://tools.ietf.org/html/rfc4122" target="_blank" rel="noopener noreferrer">RFC4122<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>json-pointer: 根据<a href="https://tools.ietf.org/html/rfc6901" target="_blank" rel="noopener noreferrer">RFC6901<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的 JSON 指针。</li> <li>relative-json-pointer: 根据<a href="http://tools.ietf.org/html/draft-luff-relative-json-pointer-00" target="_blank" rel="noopener noreferrer">该草案<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的相对 JSON 指针。</li></ul> <div class="custom-block tip"><p class="custom-block-title">请注意</p> <p>JSON Schema draft-07 同样为 URL、域名、邮箱定义了<code>iri</code>、<code>iri-reference</code>、<code>idn-hostname</code>和<code>idn-email</code>格式。不过 Ajv 并未实现他们。如果您创建了实现它们的 Ajv 插件，请提 PR。</p></div> <p>格式验证有两种模式：<code>fast</code>和<code>full</code>。模式会影响<code>date</code>、<code>time</code>、<code>date-time</code>、<code>uri</code>、<code>uri-reference</code>和<code>email</code>。请参见<a href="https://github.com/ajv-validator/ajv#options" target="_blank" rel="noopener noreferrer">配置项<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>文档。</p> <p><code>unknownFormats</code>配置项允许在遇到未知格式时更改默认行为。在这种情况下，Ajv 要么模式编译失败(默认情况)，要么忽略它(在 5.0.0 版本之前是这样的)。你还可以指定哪些格式可以忽略。</p> <p>您可以找到用于格式验证的正则表达式以及<a href="https://github.com/ajv-validator/ajv/blob/master/lib/compile/formats.js" target="_blank" rel="noopener noreferrer">formats.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中使用的源代码。</p> <h2 id="使用-ref-组合-schema">使用 $ref 组合 schema</h2> <p>您可以跨多个 schema 文件组合验证逻辑，并通过<code>$ref</code>关键字让 schema 相互引用。</p> <p>示例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;$id&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;http://example.com/schemas/schema.json&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;properties&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;foo&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;$ref&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;defs.json#/definitions/int&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;bar&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;$ref&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;defs.json#/definitions/str&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> defsSchema <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;$id&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;http://example.com/schemas/defs.json&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;definitions&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;int&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;integer&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;str&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;string&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>现在您可以将所有的 schema 传给 Ajv 实例来编译您的 schema。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> ajv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ajv</span><span class="token punctuation">(</span><span class="token punctuation">{</span>schemas<span class="token punctuation">:</span> <span class="token punctuation">[</span>schema<span class="token punctuation">,</span> defsSchema<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> validate <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">getSchema</span><span class="token punctuation">(</span><span class="token string">'http://example.com/schemas/schema.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>也可以使用<code>addSchema</code>方法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> ajv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ajv</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> validate <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">addSchema</span><span class="token punctuation">(</span>defsSchema<span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>参见<a href="https://github.com/ajv-validator/ajv#options" target="_blank" rel="noopener noreferrer">配置项<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>和<a href="https://github.com/ajv-validator/ajv#api" target="_blank" rel="noopener noreferrer">addSchema<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>方法.</p> <p><strong>请注意：</strong></p> <ul><li>使用 schema <code>id</code>作为基本<code>URI</code>(参见示例)，将<code>$ref</code>作为 URI 引用。</li> <li>引用可以是递归的(也可以相互递归)，以实现不同数据结构(如链表、树、图等)的 schema。</li> <li>您不必将 schema 文件放到作为 schema <code>id</code>的 URI 当中。这些 URI 仅用于定义 schema，根据 JSON schema 模式规范，验证器不应该期望能够从这些 URI 中下载 schema。</li> <li>没有使用 schema 文件在文件系统中的实际位置。</li> <li>您可以将 schema 的标识符作为<code>addSchema</code>方法的第二个参数或是<code>schema</code>配置项中的属性名称进行传递。该标识符可以用来代替 schema <code>$id</code>(或作为 schema <code>$id</code>的补充)。</li> <li>不能将相同的<code>$id</code>(或 schema 标识符)用于多个 schema -- 这将引发异常。</li> <li>您可以使用<code>compileAsync</code>方法实现引用 schema 的动态解析。通过这种方式，您可以在任何系统(文件、web、数据库等)中存储 schema 并引用它们，而无需显式地添加到 Ajv 实例中。参见<a href="https://github.com/ajv-validator/ajv#asynchronous-schema-compilation" target="_blank" rel="noopener noreferrer">异步 schema 编译<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="data-引用">$data 引用</h2> <p>通过<code>$data</code>配置项，您可以使用来自验证数据的值作为 schema 关键字的值。可以看看<a href="https://github.com/json-schema-org/json-schema-spec/issues/51" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>来了解它的原理。</p> <p><code>$data</code>支持在下面的关键字当中都是支持的：const, enum, format, maximum/minimum, exclusiveMaximum / exclusiveMinimum, maxLength / minLength, maxItems / minItems, maxProperties / minProperties, formatMaximum / formatMinimum, formatExclusiveMaximum / formatExclusiveMinimum, multipleOf, pattern, required, uniqueItems.</p> <p><code>&quot;$data&quot;</code>的值应该是指向数据的<a href="https://tools.ietf.org/html/rfc6901" target="_blank" rel="noopener noreferrer">JSON-Pointer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>(即使<code>$data</code>引用在被引用的子 schema 中，根始终是顶级数据对象)或<a href="http://tools.ietf.org/html/draft-luff-relative-json-pointer-00" target="_blank" rel="noopener noreferrer">relative JSON-Pointer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>(相对于数据中的当前点；如果<code>$data</code>引用在被引用的子 schema 中，那么它就不能指向这个子 schema 的根以外的数据)。</p> <p>示例：</p> <p>该 schema 要求<code>smaller</code>属性的值小于或等于<code>bigger</code>属性中的值：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> ajv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ajv</span><span class="token punctuation">(</span><span class="token punctuation">{</span>$data<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;properties&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;smaller&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;number&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;maximum&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;$data&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;1/larger&quot;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;larger&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;number&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> validData <span class="token operator">=</span> <span class="token punctuation">{</span>
  smaller<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
  larger<span class="token punctuation">:</span> <span class="token number">7</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

ajv<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>schema<span class="token punctuation">,</span> validData<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>该 schema 要求属性与他们的字段名具有相同的格式：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;additionalProperties&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;format&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;$data&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;0#&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> validData <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">'date-time'</span><span class="token punctuation">:</span> <span class="token string">'1963-06-19T08:30:06.283185Z'</span><span class="token punctuation">,</span>
  email<span class="token punctuation">:</span> <span class="token string">'joe.bloggs@example.com'</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><code>$data</code>引用会被安全地解析——即使某些属性未定义也不会抛出错误。如果<code>$data</code>解析为<code>undefined</code>，则验证成功(排除<code>const</code>关键字)。如果<code>$data</code>解析为不正确的类型(比方说，<code>maximum</code>关键字的值不是&quot;number&quot;)，验证将失败。</p> <h2 id="merge-和-patch-关键字">$merge 和 $patch 关键字</h2> <p>通过<a href="https://github.com/ajv-validator/ajv-merge-patch" target="_blank" rel="noopener noreferrer">ajv-merge-patch<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>这个包，您可以使用<code>$merge</code>关键字和<code>$patch</code>关键字，它们允许使用<a href="https://tools.ietf.org/html/rfc7396" target="_blank" rel="noopener noreferrer">JSON Merge Patch (RFC 7396)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>和<a href="https://tools.ietf.org/html/rfc6902" target="_blank" rel="noopener noreferrer">JSON Patch (RFC 6902)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>来扩展 JSON Schema。</p> <p>要向 Ajv 实例中添加<code>$merge</code>和<code>patch</code>关键字您可以这样：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ajv-merge-patch'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ajv<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>示例：</strong></p> <p>使用<code>$merge</code>：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;$merge&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;p&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;additionalProperties&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;with&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;q&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;number&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>使用<code>$patch</code>：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;$patch&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;p&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;additionalProperties&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;with&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> <span class="token property">&quot;op&quot;</span><span class="token operator">:</span> <span class="token string">&quot;add&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/properties/q&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;number&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>上面的 schema 等同于下面的：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;p&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;q&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;number&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;additionalProperties&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>关键字<code>$merge</code>和<code>$patch</code>中的<code>source</code>和<code>with</code>属性可以使用绝对或相对的<code>$ref</code>来指向之前添加到 Ajv 实例中的其他 schema 或当期 schema 的片段。</p> <p>参见左边的<a href="https://github.com/ajv-validator/ajv-merge-patch" target="_blank" rel="noopener noreferrer">Ajv-merge-patch<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>文档获得更多信息。</p> <h2 id="自定义关键字">自定义关键字</h2> <p>使用自定义关键字的好处如下：</p> <ul><li>允许创建无法使用 JSON schema 表示的验证场景。</li> <li>简化您的 schema。</li> <li>有助于为 schema 引入更大一部分验证逻辑。</li> <li>使 schema 更具表达性、更简洁、更接近应用。</li> <li>实现自定义数据处理来修改数据(修改项<strong>必须</strong>在关键字定义中使用)和/或在验证数据时创建副作用。</li></ul> <p>如果一个关键字只用于副作用，并且它的验证结果是预先定义的，那么在关键字定义中使用<code>valid: true/false</code>配置项来简化生成的代码(在<code>valid: true</code>的情况下没有错误处理)和关键字函数(不需要返回任何验证结果)。</p> <p>在使用自定义关键字扩展 JSON Schema 标准时，必须注意您的 schema 的可移植性和礼节性。您必须在其他平台上支持这些自定义关键字，且进行正确的文档说明，方便每个人都能理解。</p> <p>您也可以使用<a href="https://github.com/ajv-validator/ajv#api-addkeyword" target="_blank" rel="noopener noreferrer">addKeyword<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>方法自定义关键字。关键字是在<code>ajv</code>实例级别上定义的----新实例没有以前定义的关键字。</p> <p>Ajv 允许通过以下方式定义关键字:</p> <ul><li>验证函数</li> <li>编译函数</li> <li>宏函数</li> <li>内联编译函数，它的作用是返回当前编译 schema 中的内联编译代码(作为字符串)。</li></ul> <p>示例，使用编译 schema 的<code>range</code>和<code>exclusiveRange</code>关键字：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ajv<span class="token punctuation">.</span><span class="token function">addKeyword</span><span class="token punctuation">(</span><span class="token string">'range'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  type<span class="token punctuation">:</span> <span class="token string">'number'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">compile</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">sch<span class="token punctuation">,</span> parentSchema</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> min <span class="token operator">=</span> sch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> max <span class="token operator">=</span> sch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> parentSchema<span class="token punctuation">.</span>exclusiveRange <span class="token operator">===</span> <span class="token boolean">true</span>
            <span class="token operator">?</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> data <span class="token operator">&gt;</span> min <span class="token operator">&amp;&amp;</span> data <span class="token operator">&lt;</span> max<span class="token punctuation">;</span> <span class="token punctuation">}</span>
            <span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> data <span class="token operator">&gt;=</span> min <span class="token operator">&amp;&amp;</span> data <span class="token operator">&lt;=</span> max<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">&quot;range&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;exclusiveRange&quot;</span><span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> validate <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">2.01</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">3.99</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>在<a href="https://github.com/ajv-validator/ajv-keywords" target="_blank" rel="noopener noreferrer">ajv-keywords<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>包中定义了数个自定义关键字(<code>typeof</code>、<code>instanceof</code>、<code>range</code>和<code>propertyNames</code>)它们可以在您的 schema 中使用，并作为您自己的自定义关键字的起点。</p> <p>参见<a href="https://github.com/ajv-validator/ajv/blob/master/CUSTOM.md" target="_blank" rel="noopener noreferrer">自定义关键字<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>获取更多信息。</p> <h2 id="异步-schema-编译">异步 schema 编译</h2> <p>在异步编译期间，使用提供的函数加载远程引用。参见<code>compileAsync</code><a href="https://github.com/ajv-validator/ajv#api-compileAsync" target="_blank" rel="noopener noreferrer">方法<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>和<code>loadSchema</code><a href="https://github.com/ajv-validator/ajv#options" target="_blank" rel="noopener noreferrer">配置项<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p><strong>示例：</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> ajv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ajv</span><span class="token punctuation">(</span><span class="token punctuation">{</span> loadSchema<span class="token punctuation">:</span> loadSchema <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ajv<span class="token punctuation">.</span><span class="token function">compileAsync</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">validate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> valid <span class="token operator">=</span> <span class="token function">validate</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">loadSchema</span><span class="token punctuation">(</span><span class="token parameter">uri</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> request<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>statusCode <span class="token operator">&gt;=</span> <span class="token number">400</span><span class="token punctuation">)</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Loading error: '</span> <span class="token operator">+</span> res<span class="token punctuation">.</span>statusCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">请注意</p> <p><a href="https://github.com/ajv-validator/ajv#options" target="_blank" rel="noopener noreferrer">配置项<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><code>missingRefs</code>不应该在异步编译时设置为<code>&quot;ignore&quot;</code>或<code>&quot;fail&quot;</code>。</p></div> <h2 id="异步验证">异步验证</h2> <p>Node.js 交互式编程环境(REPL)的<a href="https://tonicdev.com/esp/ajv-asynchronous-validation" target="_blank" rel="noopener noreferrer">示例<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>您可以通过访问数据库或其他服务来定义执行异步验证的自定义格式和关键字。您应该在关键字或格式定义中添加<code>async: true</code>(参见<a href="https://github.com/ajv-validator/ajv#api-addformat" target="_blank" rel="noopener noreferrer">addFormat<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、<a href="https://github.com/ajv-validator/ajv#api-addkeyword" target="_blank" rel="noopener noreferrer">addKeyword<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>和<a href="https://github.com/ajv-validator/ajv#defining-custom-keywords" target="_blank" rel="noopener noreferrer">定义自定义关键字<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)</p> <p>如果您的 schema 使用了异步格式/关键字，或者应用了一些包含这些关键字的 schema，那么它应该带有<code>&quot;$async&quot;: true</code>关键字，以便 Ajv 能够正确编译它。如果在没有<code>$async</code>关键字的 schema 中使用异步格式/关键字或对异步 schema 的引用，那么 Ajv 将在 schema 编译期间抛出异常。</p> <div class="custom-block tip"><p class="custom-block-title">请注意</p> <p>从当前 schema 或其他 schema 引用的所有异步子 schema 也应该具有<code>&quot;$async&quot;:true</code>关键字，否则模式编译将失败。</p></div> <p>异步自定义格式/关键字的验证函数应该返回一个结果为<code>true</code>或<code>false</code>的 Promise (或者如果希望从关键字函数返回自定义错误，则使用 reject 返回<code>new Ajv.ValidationError(errors)</code>)。</p> <p>Ajv 将异步 schema 编译为 async 函数，它们可以使用<a href="https://github.com/MatAtBread/nodent" target="_blank" rel="noopener noreferrer">nodent<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>进行转换。Node.js 7+ 和所有现代浏览器都支持 async 函数。您还可以通过<code>processCode</code>配置项提供作为函数的其他转换器。参见<a href="https://github.com/ajv-validator/ajv#options" target="_blank" rel="noopener noreferrer">配置项<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>编译后的验证函数具有<code>$async: true</code>属性(如果模式是异步的)，因此如果同时使用同步模式和异步模式，您可以将它们区分开来。</p> <p>验证结果是一个返回验证数据(resolve)或带有<code>Ajv.ValidationError</code>(reject)的 Promise。</p> <p><strong>示例：</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> ajv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ajv</span><span class="token punctuation">;</span>
<span class="token comment">// require('ajv-async')(ajv);</span>

ajv<span class="token punctuation">.</span><span class="token function">addKeyword</span><span class="token punctuation">(</span><span class="token string">'idExists'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  async<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  type<span class="token punctuation">:</span> <span class="token string">'number'</span><span class="token punctuation">,</span>
  validate<span class="token punctuation">:</span> checkIdExists
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">function</span> <span class="token function">checkIdExists</span><span class="token punctuation">(</span><span class="token parameter">schema<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">knex</span><span class="token punctuation">(</span>schema<span class="token punctuation">.</span>table<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">rows</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>rows<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// true if record is found</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;$async&quot;</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string">&quot;properties&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;userId&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;integer&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;idExists&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;table&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;users&quot;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;postId&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;integer&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;idExists&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;table&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;posts&quot;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> validate <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">{</span> userId<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> postId<span class="token punctuation">:</span> <span class="token number">19</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Data is valid'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { userId: 1, postId: 19 }</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>err <span class="token keyword">instanceof</span> <span class="token class-name">Ajv<span class="token punctuation">.</span>ValidationError</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  <span class="token comment">// data is invalid</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Validation errors:'</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h3 id="使用带有异步验证函数的转换器">使用带有异步验证函数的转换器</h3> <p><a href="https://github.com/ajv-validator/ajv-async" target="_blank" rel="noopener noreferrer">ajv-async<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>使用<a href="https://github.com/MatAtBread/nodent" target="_blank" rel="noopener noreferrer">nodent<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>来转换异步函数。要使用另一个转换器，你应该单独安装它(或在浏览器中加载它的包)。</p> <p><strong>使用 nodent：</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> ajv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ajv</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ajv-async'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>ajv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 在浏览器环境，如果您想单独加载 ajv-async 的包，您可以使用：</span>
<span class="token comment">// window.ajvAsync(ajv);</span>
<span class="token keyword">var</span> validate <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 转换 es7 async function</span>
<span class="token function">validate</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>successFunc<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>errorFunc<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>使用其他转换器：</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> ajv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ajv</span><span class="token punctuation">(</span><span class="token punctuation">{</span> processCode<span class="token punctuation">:</span> transpileFunc <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> validate <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 转换 es7 async function</span>
<span class="token function">validate</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>successFunc<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>errorFunc<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="安全注意事项">安全注意事项</h2> <p>如果使用得当，JSON Schema 可以替代数据清理，但并不会取代其他的 API 安全注意事项。它引入了其它需要考虑的安全方面的事项。</p> <h4 id="安全隐患汇报">安全隐患汇报</h4> <p>若要报告安全漏洞，请使用<a href="https://tidelift.com/security" target="_blank" rel="noopener noreferrer">Tidelift 安全隐患汇报<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。Tidelift 将协调修复和披露安全隐患。请不要使用 GitHub 报告安全漏洞。</p> <h4 id="不可信的-schema">不可信的 schema</h4> <p>Ajv 将 JSON schema 视为受信任的代码。该安全模型基于最常见的用例，即 schema 是静态的并与应用程序绑定在一起。</p> <p>如果您的 schema 是从不可信的来源获得的（或是从不可信数据生成的），那么下面几种情况就是您要竭力避免的：</p> <ul><li>编译 schema 可能导致堆栈溢出(如果太深的话)。</li> <li>编译 schema 可能太慢了。</li> <li>验证某些数据较慢。</li></ul> <p>虽然很难预测所有的场景，但至少它可以帮助限制不可信 schema 的大小(例如限制 JSON 字符串长度)和 schema 对象的最大深度(相对于较小的 JSON 字符串，这个深度可能很高)。您还可以将较慢的正则表达式放到<code>pattern</code>和<code>patternProperties</code>关键字中。</p> <p>无论您采取何种措施，使用不受信任的模式都会增加安全风险。</p> <h4 id="javascript-对象中的循环引用">JavaScript 对象中的循环引用</h4> <p>Ajv 不支持在对象中具有循环引用的 schema 和验证数据。参见<a href="https://github.com/ajv-validator/ajv/issues/802" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>尝试编译这样的 schema 或验证这样的数据会导致堆栈溢出(或者异步验证不会完成)。根据所使用的解析器的不同，不受信任的数据可能导致循环引用。</p> <h4 id="受信任-schema-的安全风险">受信任 schema 的安全风险</h4> <p>JSON schema 中的一些关键字可能导致对某些数据的验证非常缓慢。这些数字包括(但可能不限于)：</p> <ul><li>用<code>pattern</code>和<code>format</code>匹配大量字符串 ———— 在某些情况下<code>maxLength</code>可以帮我我们缓解它，但某些正则表达式可能导致验证时间呈指数级增长，即使是相对较短的字符串(参见下面的 ReDoS 攻击)。</li> <li>用<code>patternProperties</code>匹配大量属性名称 ———— 使用<code>propertyNames</code>来缓解，但是一些正则表达式也可能会有指数级的计算时间。</li> <li>用于大型非表里数组的<code>uniqueItems</code> ———— 使用<code>maxItems</code>来缓解。</li></ul> <div class="custom-block warning"><p class="custom-block-title">请注意</p> <p>只有在生产环境代码中不使用<code>allErrors:true</code>时，上面防止缓慢验证的建议才起效(使用它将在验证错误之后继续验证)。</p></div> <p>您可以根据<a href="https://github.com/ajv-validator/ajv/blob/master/lib/refs/json-schema-secure.json" target="_blank" rel="noopener noreferrer">元 schema<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>来验证您的 JSON schema 以检查是否遵循了以下协议：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> isSchemaSecure <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ajv/lib/refs/json-schema-secure.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> schema1 <span class="token operator">=</span> <span class="token punctuation">{</span>format<span class="token punctuation">:</span> <span class="token string">'email'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">isSchemaSecure</span><span class="token punctuation">(</span>schema1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>

<span class="token keyword">const</span> schema2 <span class="token operator">=</span> <span class="token punctuation">{</span>format<span class="token punctuation">:</span> <span class="token string">'email'</span><span class="token punctuation">,</span> maxLength<span class="token punctuation">:</span> <span class="token constant">MAX_LENGTH</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">isSchemaSecure</span><span class="token punctuation">(</span>schema2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">谨记</p> <p>遵循所有这些建议并不能保证对不可信数据的验证是安全的 ———— 凡事总有意外嘛。</p></div> <h2 id="正则dos攻击-redos-attack">正则Dos攻击(ReDos Attack)</h2> <p>即使字符串相对较短，某些正则表达式也可能导致计算时间呈指数级成长。</p> <p>请评估您在模式中使用的正则表达式对这种攻击的抵抗力 —— 参见<a href="https://github.com/substack/safe-regex" target="_blank" rel="noopener noreferrer">安全正则<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <div class="custom-block tip"><p class="custom-block-title">请注意</p> <p>Ajv 使用<a href="https://github.com/ajv-validator/ajv/blob/master/lib/compile/formats.js" target="_blank" rel="noopener noreferrer">正则表达式<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>实现了一些格式，它们容易遭到 ReDoS 攻击，所以如果你使用 Ajv 验证来自不可信来源的数据，强烈建议考虑以下几点：</p> <ul><li>评估 Ajv 中&quot;格式&quot;的实现。</li> <li>使用<code>format: 'fast'</code>配置项简化了一些正则表达式(尽管这也不能保证它们是安全的)。</li> <li>将 Ajv 提供的格式实现替换成您自己的<code>format</code>关键字实现，这些实现使用不同的正则表达式或另一种格式验证方法。参见<a href="https://github.com/ajv-validator/ajv#api-addformat" target="_blank" rel="noopener noreferrer">addFormat<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>方法。</li> <li>禁用格式验证，使用<code>format: false</code>忽略<code>format</code>关键字。</li></ul> <p>无论您选择哪种措施，请先假定 Ajv 提供的所有格式都不安全，并自行评估它是否适合您的验证场景。</p></div> <h2 id="过滤数据">过滤数据</h2> <p>利用<a href="https://github.com/ajv-validator/ajv#options" target="_blank" rel="noopener noreferrer">removeAdditional<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>配置项您可以在验证期间过滤数据。</p> <p>它会修改原始数据。</p> <p>示例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> ajv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ajv</span><span class="token punctuation">(</span><span class="token punctuation">{</span> removeAdditional<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;additionalProperties&quot;</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string">&quot;properties&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;foo&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;number&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;bar&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;additionalProperties&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;number&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;properties&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;baz&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;string&quot;</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;foo&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">&quot;additional1&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 将会被移除; `additionalProperties` == false</span>
  <span class="token string">&quot;bar&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;baz&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;abc&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;additional2&quot;</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment">// 不会被移除; `additionalProperties` != false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> validate <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { &quot;foo&quot;: 0, &quot;bar&quot;: { &quot;baz&quot;: &quot;abc&quot;, &quot;additional2&quot;: 2 }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>如果上面示例中的<code>removeAdditional</code>配置项是<code>&quot;all&quot;</code>，那么<code>additional1</code>和<code>additional2</code>属性都将被删除。</p> <p>如果配置项是<code>&quot;failing&quot;</code>那么<code>additional1</code>就已经被移除，无论其值为多少。<code>additional2</code>则只有当它的值在内部<code>additionalProperties</code>中的 schema 中失败时会被移除(因此在上面的示例中，它会保留下来，因为它传递了 schema，但任何非数字将被删除)。</p> <div class="custom-block warning"><p class="custom-block-title">请注意</p> <p>如果你使用的<code>removeAdditional</code>配置项内含有带有<code>additionalProperties</code>的<code>anyOf</code>/<code>oneOf</code>关键字，你的验证可能会失败，例如:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;oneOf&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;properties&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;foo&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;string&quot;</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;required&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;foo&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">&quot;additionalProperties&quot;</span><span class="token punctuation">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;properties&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;bar&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;integer&quot;</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;required&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;bar&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">&quot;additionalProperties&quot;</span><span class="token punctuation">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div></div> <p>上述 schema 的旨在允许字符串属性“foo”或整数属性“bar”的对象，但不允许同时具有这两个属性或任何其他属性的对象。</p> <p>当配置了<code>removeAdditional: true</code>时，对象<code>{&quot; foo&quot;: &quot;abc&quot;}</code>会通过验证，但<code>{&quot;bar&quot;: 1}</code>会失败。发生这种情况的原因是，当验证<code>oneOf</code>第一个子级 schema 时，属性<code>bar</code>被删除了，因为根据标准，它是一个附加属性(因为它并未包含在相同 schema 的<code>properties</code>关键字中)。</p> <p>虽然这种情况是意料之外的，但它是正确的。开发者若想达成期望的行为(两个对象中都是合法属性，但附加属性被删除了)，需要对 schema 按照以下方式重构：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;foo&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;bar&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;integer&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;additionalProperties&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token property">&quot;oneOf&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token property">&quot;required&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;foo&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token property">&quot;required&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;bar&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>上面的 schema 更有效，它编译成的函数更快。</p> <h2 id="配置默认值">配置默认值</h2> <p>通过<a href="https://github.com/ajv-validator/ajv#options" target="_blank" rel="noopener noreferrer">useDefaults<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>配置项，Ajv 将把<code>priperties</code>和<code>items</code>的 schema (当它是 schema 数组时)中的<code>default</code>关键字的值配置给丢失的属性和项。</p> <p>当配置项为<code>&quot;empty&quot;</code>时，属性和项的值为<code>null</code>或<code>&quot;&quot;</code>(空字符串)会被认为丢失并设置为默认值。</p> <p><strong>该配置项会修改原始数据。</strong></p> <div class="custom-block tip"><p class="custom-block-title">请注意</p> <p>默认值作为文本被插入到生成的验证代码中，因此插入到数据中的值将是 schema 中默认值的深拷贝。</p></div> <p>示例1 (<code>properties</code>中的<code>default</code>)：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> ajv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ajv</span><span class="token punctuation">(</span><span class="token punctuation">{</span> useDefaults<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;properties&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;foo&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;number&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;bar&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;baz&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;required&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bar&quot;</span> <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> validate <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { &quot;foo&quot;: 1, &quot;bar&quot;: &quot;baz&quot; }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>示例2 (<code>items</code>中的<code>default</code>)：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;array&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;items&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;number&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;foo&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> validate <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [ 1, &quot;foo&quot; ]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>其他情况<code>default</code>关键字会被忽略：</p> <ul><li>不在<code>properties</code>或<code>items</code>的子级 schema 中。</li> <li>在<code>anyOf</code>、<code>oneOf</code>和<code>not</code>中的 schema 中。</li> <li>在<code>switch</code>关键字的<code>if</code>子级 schema 中。</li> <li>在由自定义宏关键字生成的 schema 中。</li></ul> <p><a href="https://github.com/ajv-validator/ajv#options" target="_blank" rel="noopener noreferrer">strictDefaults<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>配置项定制了 Ajv 的行为，补强了 Ajv 忽略掉的默认值情况(设置为<code>true</code>会引发错误，<code>&quot;log&quot;</code>则会输出警告)。</p> <h2 id="强制数据类型转换">强制数据类型转换</h2> <p>在验证用户输入时，所有数据属性通常都是字符串。<code>coerceTypes</code>配置项允许您将数据类型强制转换为 schema <code>type</code>关键字中指定的类型，以便通过验证并在之后使用正确类型的数据。</p> <p><strong>该配置项会修改原始数据。</strong></p> <div class="custom-block warning"><p class="custom-block-title">请注意</p> <p>如果您将值类型传递给验证函数，它将被强制规定类型并且通过验证，但是您传递的变量的值将不会被更新，因为值类型是按值传递的。</p></div> <p>示例1：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> ajv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ajv</span><span class="token punctuation">(</span><span class="token punctuation">{</span> coerceTypes<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;properties&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;foo&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;number&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;bar&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;boolean&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;required&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bar&quot;</span> <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;false&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> validate <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { &quot;foo&quot;: 1, &quot;bar&quot;: false }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>示例2（强制数组）：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> ajv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ajv</span><span class="token punctuation">(</span><span class="token punctuation">{</span> coerceTypes<span class="token punctuation">:</span> <span class="token string">'array'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;properties&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;foo&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;array&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;items&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;number&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;bar&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;boolean&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;false&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> validate <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">validate</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// { &quot;foo&quot;: [1], &quot;bar&quot;: false }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>从示例中可以看到，强制规则与 JavaScript 是不同的，它可以按期望验证用户输入，并让过程可逆(从而正确验证在“anyOf”和其他复合关键字的子级 schema 中定义不同类型的情况)。</p> <p>参见<a href="https://github.com/ajv-validator/ajv/blob/master/COERCION.md" target="_blank" rel="noopener noreferrer">强制类型转换<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>文档了解更多细节。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/ajv-docs-zh-cn/routes/basic/validation.html">
        验证
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/ajv-docs-zh-cn/assets/js/app.4497bbb7.js" defer></script><script src="/ajv-docs-zh-cn/assets/js/2.c7b6054d.js" defer></script><script src="/ajv-docs-zh-cn/assets/js/13.032c4277.js" defer></script><script src="/ajv-docs-zh-cn/assets/js/5.9dba54a7.js" defer></script>
  </body>
</html>
